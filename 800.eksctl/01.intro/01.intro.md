# eksctl 

## 소개

### 클러스터 목록 보기

모든 클러스터에 대한 상세 정보를 확인하기. 

```go
eksctl get cluster [--name=<name>][--region=<region>]
```

### 클러스터 생성하기. 

```go
eksctl create cluster --name=cluster-1 --nodes=4
```

EKS 가 제공하는 버젼은 1.15, 1.16, 1.17, 1.18, 1.19, 1.20이 가능

eksctl은 --version 을 이용하여 버젼을 지정할 수 있다. 

```go
eksctl create cluster --version=1.18
```

#### 생성을 위한 옵션 

--config-file 라는 파라미터를 이용하여 모든 설정 정보를 생성시 전달할 수 있다. 

```go
eksctl create cluster --config-file=<path>
```

설정 파일을 이용하여 클러스터를 생성하고, 노드 그룹을 지정하지 않는다면 다음과 같이 생성가능하다. 

```go
eksctl create cluster --config-file=<path> --without-nodegroup
```

#### 클러스터 credential

cluster credential 을 파일에 쓰려면 다음과 같이 작성한다. 

```go
eksctl create cluster --name=cluster-2 --nodes=4 --kubeconfig=./kubeconfig.cluster-2.yaml
```

클러스터 credential 을 저장하는 것을 막기 위해서 다음과 같이 수행할 수 있다. 

```go
eksctl create cluster --name=cluster-3 --nodes=4 --write-kubeconfig=false
```

eksctl ~/.kube/eksctl/clusters 디렉토리 하위에 credential을 저장하는 법

```go
eksctl create cluster --name=cluster-3 --nodes=4 --auto-kubeconfig
```

cluster credentials를 획득하기 위해서는 다음을 실행하자. 

```go
eksctl utils write-kubeconfig --cluster=<name> [--kubeconfig=<path>][--set-kubeconfig-context=<bool>]
```

### Autoscaling

3-5개의 노드를 Auto scaling group 를 이용하려면 다음과 같이 수행할 수 있다. 

```go
eksctl create cluster --name=cluster-5 --nodes-min=3 --nodes-max=5
```

### SSH 접근

SSH 로 각 노드에 접근하고자 한다면 eksctl 이 ~/.ssh/id_rsa.pub 를 기본적으로 로드한다. 

다른 public key 를 이용하고자 한다면 my_eks_node_id.pub 를 예를 들면 다음과 같이 수행하자. 

```go
eksctl create cluster --ssh-access --ssh-public-key=my_eks_node_id.pub
```

이미 존재하는 EC2 키 쌍이 us-east-1 에 있다면, 직접 키 쌍의 이름을 지정할 수 있다. 

```go
eksctl create cluster --ssh-access --ssh-public-key=my_kubernetes_key --region=us-east-1
```

만약 AWS System Manager (SSM) 을 이용하여 노드에 SSH를 할당한다면 --enable-ssm 플래그를 주자. 

```go
eksctl create cluster --enable-ssm
```

Note: 사용자 지정 시작 템플릿을 사용하여 관리형 노드를 생성하는 경우 --enable-ssm 플래그가 하용되지 않는다. 

### 태깅

모든 리소스에 커스텀 태그를 만드는 경우 --tags를 이용하자. 

```go
eksctl create cluster --tags environment=staging --region=us-east-1
```

### 볼륨 지정하기. 

기본 볼륨은 80GB이다. 

노드 루트 볼륨을 설정하려면, --node-volume-size 를 이용하고, 선택적으로 --node-volume-type 도 가능하다. 

```go
eksctl create cluster --node-volume-size=50 --node-volume-type=io1
```

### 삭제

클러스터를 삭제하기 위해서 다음과 같이 커맨드를 보내자. 

```go
eksctl delete cluster --name=<name> [--region=<region>]
```

클러스터 정보는 kubernetes config 파일에 의해서 삭제 될 것이다. 

kubectl config get-context 를 실행해서 올바른 컨텍스트를 선택해서 삭제하자. 

## 설치 

최신 버젼을 다운로드하자. 

```go
curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin
```

### MacOS

Homebrew 를 이용할 수 있다. 

```go
brew tap weaveworks/tap
brew install weaveworks/tap/eksctl
```

###  MacPort

```go
port install eksctl
```

### Windows

윈도우는 chocolatey 를 이용한다. 

```go
chocolatey install eksctl
```

### scoop

```go
scoop install eksctl
```

AWS API credentials 설정을 해야한다. 

AWS CLI 혹은 다른 툴들 (kops, Terraform)을 이용한다면 충분하다. 

~/.aws/credentials 파일을 이용할 수 있다. environment variables 를 이용할 수 있다. 

또한 AWS IAM Authenticator for Kubernetes 커맨드가 필요하다. (aws-iam-authenticator 혹은 aws eks get-token 을 패스에 이용할 수 있다.)

## Shell Completion

### Bash

~/.bashrc 혹은 ~/.profile

```go
. <(eksctl completion bash)
```

### Zsh

zsh completion 을 위해서 다음과 같이 수행하자. 

```go
mkdir -p ~/.zsh/completion/
eksctl completion zsh > ~/.zsh/completion/_eksctl
```

그리고 ~/.zshrc 를 추가하자. 

```go
fpath=($fpath ~/.zsh/completion)
```

만약 oh-my-zsh 를 실행하지 않았다면 다음을 통해서 자동완성을 활성화 하자. 혹은 ~/.zshrc 에 추가하자. 

```go
autoload -U compinit
compinit
```

### Fish

아래 커맨드를 통해서 fish auto completion 을 사용할 수 있다. 

```go
mkdir -p ~/.config/fish/completions
eksctl completion fish > ~/.config/fish/completions/eksctl.fish
```

### Powershell

아래 커맨드는 설정을 위해서 참조하자. 

```go
eksctl completion powershell > C:\Users\Documents\WindowsPowerShell\Scripts\eksctl.ps1
```



