# EKS Information

## EKS 가격 

- 각 EKS Cluster 마다 $0.10/hour
- app과 관련된 모든 리소스에 대한 비용 발생. 
  - Worker nodes (EC2 Instance)
  - EBS volumes
  - Network traffic
  - Load Balancers

[AWS Pricing](https://aws.amazon.com/ko/eks/pricing/)

# Control Plane

- 기본적으로 멀티 AZ를 지원한다. 
- AZ 구성
  - AZ a
    - Master Node : AWS가 관리 
    - Etcd : AWS가 관리
    - Worker Nodes : 사용자가 관리 
  - AZ b
    - Master Node : AWS가 관리 
    - Etcd : AWS가 관리
    - Worker Nodes : 사용자가 관리 
  - AZ c
    - Master Node : AWS가 관리 
    - Etcd : AWS가 관리
    - Worker Nodes : 사용자가 관리 

- Kubectl <--> Amazon EKS (mycluster.eks.amazonaws.com) <--> 각 AZ의 worker node 와 통신 
- EKS Kubernetes Control Plane는 고가용성을 가진다. 
- Single tenant (다른 사용자와 자원을 공유하지 않는다.)
- AWS리소스로 구성된다. (EC2, ELB, ASG, NLB, VPC) 등 
- 전체 Control Plane는 NLB가 앞에 있어서 부하분산 (고정된 IP로 처리됨)
  
[Kubernetes Security Best Practice](https://github.com/freach/kubernetes-security-best-practice/blob/master/README.md#firewall-ports-fire)

[Amazon EKS security group considerations](https://docs.aws.amazon.com/eks/latest/userguide/sec-group-reqs.html)

[IP addresses per network interface per instance type](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI)

[Installing Calico on Amazon EKS](https://docs.aws.amazon.com/eks/latest/userguide/calico.html)

## EKS Networking

- VPC
  - Private subnet: 모든 워커 노드들은 어플리케이션 디플로이를 위해서 큰 CIDR 을 가져야한다.
  - Public subnet: 어플리케이션을 노출하기 위해 인터넷에 노출 
  - Private로 어플리케이션을 노출되지 않도록 구성
  - Public은 오직 인터넷에 노출되어도 되는 것만 배치 

- Security Group Rule
  - Worker Nodes --- 443(TLS) ---> Master Node
  - Master Nodes --- 1024-65535 ---> Worker Node
  - Worker Nodes --- All Ports ---> Nodes
  - Worker Nodes --- 0.0.0.0/0 all --> outside

- Subnet
  - CIDR/24 = 254, 충분하지 않음
  - CIDR/18, 많은 IP (16,384), 파드를 실행하기 충분

- Calico 사용 (선택적)
  - SG 는 모든 워커 노드들이 서로 어떠한 포트로든지 통신하기 위해서 허용해야함
  - 이는 어플리케이션 분리나, tenant, 환경 등에 대한 이슈 발생 
  - SG이용 대신에 Calico 를 설치해서 사용가능
  - 네트워크 정책은 pod에 직접 할당하고, (worker node에 할당하지 않음)
  - 효과적으로 보안그룹을 다시 만든다. pod level 이다. 

## IAM과 RBAC 통합

- 인증은 IAM을 수행 
- 권한은 RBAC로 수행 
- AWS, Heptio 와 콜라보를 통해서 수행
- RBAC를 직접 IAM 엔터티에 부여 가능 
- 기본적으로 K8S 클러스터에 롤을 할당할때 system:master 퍼미션을 가진다. 

## EKS Load Balancer

- EKS 지원
  - Classic Load Balancer
  - Application Load Balancer
  - Network Load Balancer

- Classic, Network LB 는 "Load Balancer" 라는 서비스 타입을 위해서 사용 
- ALB 는 Ingress 를 위해서 사용 
  
[AWS Loadbalancer](https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer)

[AWS Loadbalancer Controller](https://github.com/kubernetes-sigs/aws-load-balancer-controller)


